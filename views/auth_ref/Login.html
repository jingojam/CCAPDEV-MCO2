
<html>
    <head>
        <title>LABS Reservation Login</title>
        <link rel="stylesheet" href="MC1.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"  rel="stylesheet">
        <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
     body, button, input, textarea, select {
    font-family: 'Inter' !important;
  }
</style>
    </head>
    <body>
        <div class="miniheader">
          
            <h1>@LabRes</h1>
          </div>

        <div class="container">
            <div class="register">
              <br><br>
                <h1>Log In</h1><br>
                <form id="loginForm">
                <h3>DLSU Email</h3><br>
                <input type="email" name="DLSUemail" placeholder="DLSU Email"><br><br>

                <h3>Password</h3><br>
                <input type="password" name="password" placeholder="Your Password">
                <br>
                <br>
                <input type="checkbox" id="remember">
                <label id="remember">Remember me</label><br>
                <br>
                <button type="submit" class="btn btn-outline-success">Submit</button>
                </form>
                <p>Don't have an Account? <a href="Register.html">Click Here</a> to Sign up!</p>
            </div>
        </div>

<script>
  // === REDIRECT BASED ON USER ROLE (MOVED OUTSIDE) ===
  function roleredirect(user) {
    if (user.role === "Technician") {
      console.log("Redirecting to Technician page");
      window.location.href = "../../LABTECH/reservations/reserve_home.html";
    } else {
      console.log("Redirecting to Student page");
      window.location.href = "../reservations/reserve_home.html";
    }
  }

  // === AUTO-LOGIN & FORM RESTORE LOGIC ===
  window.addEventListener("pageshow", () => {
    const remembered = localStorage.getItem("rememberedUser");
    if (!remembered) return;

    try {
      const { email, password, expiresAt } = JSON.parse(remembered);

      if (new Date() > new Date(expiresAt)) {
        localStorage.removeItem("rememberedUser");
        return;
      }

      const storedUsersJSON = localStorage.getItem("users");
      if (!storedUsersJSON) return;

      const storedUsers = JSON.parse(storedUsersJSON);
      const user = storedUsers[email];

      if (!user || user.password !== password) {
        localStorage.removeItem("rememberedUser");
        return;
      }

      // Save current user
      localStorage.setItem("thisUser", JSON.stringify(user));

      // Auto-fill form
      document.querySelector("input[name='DLSUemail']").value = email;
      document.querySelector("input[name='password']").value = password;
      document.getElementById("remember").checked = true;

      // Redirect
      roleredirect(user); // Pass actual user object

    } catch (e) {
      console.error("Error restoring session:", e);
      localStorage.removeItem("rememberedUser");
    }
  });

  // === HANDLE FORM SUBMIT ===
  const form = document.querySelector("#loginForm");  
  if (!form) {
    console.error("Login form not found!");
  } else {
    form.addEventListener("submit", function (event) {
      event.preventDefault();

      const emailInput = document.querySelector("input[name='DLSUemail']");
      const passwordInput = document.querySelector("input[name='password']");
      const rememberCheckbox = document.getElementById("remember");

      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      const storedUsersJSON = localStorage.getItem("users");
      if (!storedUsersJSON) {
        alert("No registered users found. Please register first.");
        return;
      }

      const storedUsers = JSON.parse(storedUsersJSON);
      const user = storedUsers[email];

      if (!user || user.password !== password) {
        alert("Invalid email or password.");
        return;
      }

      // Save current user
      localStorage.setItem("thisUser", JSON.stringify(user));

      // Handle "Remember Me"
      if (rememberCheckbox.checked) {
        const now = new Date();
        const expiresAt = new Date(now.getTime() + 21 * 24 * 60 * 60 * 1000); // 3 weeks

        localStorage.setItem("rememberedUser", JSON.stringify({
          email,
          password,
          expiresAt: expiresAt.toISOString()
        }));
      } else {
        localStorage.removeItem("rememberedUser");
      }

      // Redirect after login
      roleredirect(user); // Use actual user object, NOT string
    });
  }
</script>
    </body>
</html>